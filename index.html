<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cálculo cotas tubería y coordenadas</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:rgba(17,24,39,.12);
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --accent:#2563eb;
      --accent2:#1d4ed8;
    }
    *{
      box-sizing:border-box;
      font-family: "Century Gothic","CenturyGothic","AppleGothic",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
    }
    body{ margin:0; background: var(--bg); color:var(--text); }
    .wrap{ max-width:1400px; margin:24px auto; padding:0 16px 60px; }

    header{
      display:flex; gap:14px; align-items:flex-start;
      justify-content:space-between; flex-wrap:wrap; margin-bottom:10px;
    }
    .brand{ display:flex; gap:14px; align-items:center; }
    .brand img{
      width:54px; height:54px; object-fit:contain;
      border-radius:14px; border:1px solid var(--line);
      background:#fff; padding:6px;
      box-shadow: 0 6px 16px rgba(0,0,0,.10);
    }
    h1{ margin:0; font-size:20px; letter-spacing:.2px; }
    .sub{ margin:6px 0 0; color:var(--muted); font-size:13px; max-width:980px; }

    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{
      display:inline-flex; padding:6px 10px;
      border:1px solid var(--line); border-radius:999px;
      font-size:12px; color:var(--muted);
      gap:8px; align-items:center; background:#fff;
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:#16a34a; display:inline-block; }
    .dot.warn{ background:#f59e0b; }

    button{
      border:1px solid var(--line); background:#fff; color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer;
      font-weight:700; font-size:13px;
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
    }
    button:hover{ border-color:rgba(17,24,39,.25); }
    button.primary{
      background: linear-gradient(180deg, rgba(37,99,235,.95), rgba(29,78,216,.95));
      border-color: rgba(29,78,216,.65);
      color:#fff;
      box-shadow: 0 12px 25px rgba(29,78,216,.18);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr 1.6fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 1100px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow: var(--shadow);
      position:relative;
    }
    .card h2{
      margin:0 0 10px;
      font-size:13px;
      color:var(--muted);
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.12em;
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr 260px;
      gap:10px 14px;
    }
    .kv .k{ color:var(--text); font-weight:700; font-size:13px; }
    .kv .v{
      color:var(--text);
      font-variant-numeric: tabular-nums;
      text-align:right;
      padding:7px 10px;
      border:1px solid rgba(17,24,39,.10);
      border-radius:12px;
      background:#f9fafb;
    }
    .v.empty{ color: rgba(17,24,39,.45); }

    .hint{ margin-top:10px; color:var(--muted); font-size:12px; }

    .table-wrap{
      overflow:auto;
      max-height:610px;
      border-radius:14px;
      border:1px solid rgba(17,24,39,.10);
      background:#fff;
    }
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      padding:10px 10px;
      border-bottom:1px solid rgba(17,24,39,.10);
      position:sticky;
      top:0;
      background:#ffffff;
      z-index:1;
      white-space:nowrap;
    }
    tbody td{
      padding:10px;
      border-bottom:1px solid rgba(17,24,39,.08);
      font-size:13px;
      vertical-align:top;
      white-space:nowrap;
    }
    tbody tr:hover td{ background:#f9fafb; }
    .num{ text-align:right; font-variant-numeric: tabular-nums; }

    .corner-logo{
      position:absolute;
      right:18px;
      bottom:18px;
      width:160px;
      height:160px;
      border-radius:18px;
      border:1px solid rgba(17,24,39,.10);
      background:#fff;
      box-shadow: 0 18px 45px rgba(0,0,0,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      pointer-events:none;
    }
    .corner-logo img{
      width:100%;
      height:100%;
      object-fit:contain;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.18));
    }
    @media (max-width: 1100px){
      .corner-logo{ width:120px; height:120px; right:12px; bottom:12px; }
    }

    dialog{
      width:min(760px, calc(100% - 24px));
      border:none;
      border-radius:18px;
      padding:0;
      background:#ffffff;
      color:var(--text);
      box-shadow: 0 30px 90px rgba(0,0,0,.35);
      border:1px solid rgba(17,24,39,.12);
    }
    dialog::backdrop{ background:rgba(0,0,0,.35); backdrop-filter: blur(2px); }
    .dlg-hd{ padding:14px 16px; border-bottom:1px solid rgba(17,24,39,.10); display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .dlg-hd b{ font-size:14px; }
    .dlg-bd{ padding:14px 16px 4px; }
    .dlg-ft{ padding:12px 16px 16px; display:flex; gap:10px; justify-content:flex-end; }

    .form{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 920px){ .form{ grid-template-columns:1fr; } }
    label{ display:flex; flex-direction:column; gap:6px; font-size:12px; color:var(--muted); }
    input{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(17,24,39,.14);
      background:#fff;
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    input::placeholder{ color: rgba(107,114,128,.55); }
    input:focus{ border-color: rgba(37,99,235,.65); box-shadow: 0 0 0 3px rgba(37,99,235,.18); }
    .row2{ grid-column: 1 / -1; }
    .small{ font-size:12px; color:var(--muted); margin-top:10px; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="Logo.png" alt="Logo" onerror="this.style.display='none'">
        <div>
          <h1>Cálculo cotas tubería y coordenadas</h1>
          <p class="sub">
            ABS/DIST se miden desde el nodo pozo (K0+000.000).
            Inicio = K0+OffPozo. Final = K0+LongEfectiva.
          </p>
        </div>
      </div>

      <div class="toolbar">
        <span class="pill"><span class="dot" id="statusDot"></span><span id="statusText">Listo</span></span>
        <button class="primary" id="btnBasic">Editar datos básicos</button>
        <button id="btnCSV">Exportar CSV</button>
        <button id="btnClear">Limpiar todo</button>
      </div>
    </header>

    <section class="grid">
      <div class="card">
        <h2>Datos básicos</h2>
        <div class="kv" id="basicKV"></div>
        <div class="hint">Regla: AbsInicio = OffPozo y AbsFinal = LongEfectiva (como lo pediste).</div>
      </div>

      <div class="card" id="tableCard">
        <h2>Tabla (puntos / Abs)</h2>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="min-width:80px;">Punto</th>
                <th style="min-width:140px;">Abs</th>
                <th style="min-width:120px;" class="num">Dist (m)</th>
                <th style="min-width:130px;" class="num">Cota Lomo</th>
                <th style="min-width:140px;" class="num">Cota Excavación</th>
                <th style="min-width:140px;" class="num">Cota Gravilla</th>
                <th style="min-width:150px;" class="num">Norte</th>
                <th style="min-width:150px;" class="num">Este</th>
                <th style="min-width:220px;">Tubo (si aplica)</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="hint" id="tableHint"></div>

        <div class="corner-logo" aria-hidden="true">
          <img src="Logo.png" alt="" onerror="this.parentElement.style.display='none'">
        </div>
      </div>
    </section>
  </div>

  <!-- Dialog: autor -->
  <dialog id="dlgAuthor">
    <div class="dlg-hd">
      <b>Información</b>
      <button id="closeAuthor">Cerrar</button>
    </div>
    <div class="dlg-bd">
      <p style="margin:0 0 10px; color:#111827; font-weight:700;">
        Creado por: Sergio H. Rico Sierra – Ing. Topográfico
      </p>
      <p style="margin:0 0 14px; color:#6b7280; font-size:13px;">
        Herramienta de cálculo y generación de cotas y coordenadas para tubería (visualización compatible con PC y móviles).
      </p>
    </div>
    <div class="dlg-ft">
      <button class="primary" id="okAuthor">Entendido</button>
    </div>
  </dialog>

  <!-- Dialog: básicos -->
  <dialog id="dlgBasic">
    <form method="dialog" id="formBasic">
      <div class="dlg-hd">
        <b>Datos básicos del tramo</b>
        <button value="cancel">Cerrar</button>
      </div>

      <div class="dlg-bd">
        <div class="form">
          <label>
            Longitud Nodo pozo a tubo (m)
            <input name="offPozo" type="number" step="0.001" placeholder="Ej: 0.600" required />
          </label>

          <label>
            Longitud nodo caja a tubo (m)
            <input name="offCaja" type="number" step="0.001" placeholder="Ej: 0.400" required />
          </label>

          <label>
            Pendiente (%)
            <input name="pendiente" type="number" step="0.001" placeholder="Ej: 2.000" required />
          </label>

          <label>
            Cota Lomo Pozo (K0+000.000)
            <input name="cotaPozo" type="number" step="0.001" placeholder="Ej: 2561.704" required />
          </label>

          <label>
            Cota Lomo Caja
            <input name="cotaCaja" type="number" step="0.001" placeholder="Ej: 2561.893" required />
          </label>

          <label>
            Longitud tubo (m)
            <input name="longTubo" type="number" step="0.001" placeholder="Ej: 1.250" required />
          </label>

          <label>
            Diámetro de tubería (m)
            <input name="diametro" type="number" step="0.001" placeholder="Ej: 0.254" required />
          </label>

          <label>
            Espesor pared tubo (m)
            <input name="espesor" type="number" step="0.001" placeholder="Ej: 0.0065" required />
          </label>

          <label>
            Nodo Pozo - Norte
            <input name="nPozo" type="number" step="0.001" placeholder="Ej: 106689.337" required />
          </label>

          <label>
            Nodo Pozo - Este
            <input name="ePozo" type="number" step="0.001" placeholder="Ej: 101688.028" required />
          </label>

          <label>
            Nodo Caja - Norte
            <input name="nCaja" type="number" step="0.001" placeholder="Ej: 106692.225" required />
          </label>

          <label>
            Nodo Caja - Este
            <input name="eCaja" type="number" step="0.001" placeholder="Ej: 101698.071" required />
          </label>

          <label class="row2">
            Longitud entre nodos (m) [calculada]
            <input name="longEntreNodos" type="text" readonly placeholder="Se calcula automáticamente" />
          </label>

          <label class="row2">
            Longitud efectiva tubería (m) = LongEntreNodos − (OffPozo + OffCaja)
            <input name="longEfectiva" type="text" readonly placeholder="Se calcula automáticamente" />
          </label>

          <label class="row2">
            Número de tubos (completos + colilla si aplica)
            <input name="numTubesPreview" type="text" readonly placeholder="Se calcula automáticamente" />
          </label>

          <div class="row2 small">
            Inicio ABS = K0+OffPozo. Cierre ABS = K0+LongEfectiva.
          </div>
        </div>
      </div>

      <div class="dlg-ft">
        <button value="cancel">Cancelar</button>
        <button class="primary" value="save">Guardar y recalcular tabla</button>
      </div>
    </form>
  </dialog>

  <script>
    const STORAGE_KEY = "calculo_cotas_coord_v13";
    const DEFAULT_OFF_POZO = 0.600;
    const DEFAULT_OFF_CAJA = 0.400;

    const ABS_PREFIX = "K0+";
    const EPS = 1e-9;

    const state = { basic: {}, rows: [] };

    const $ = (sel) => document.querySelector(sel);
    const statusDot = $("#statusDot");
    const statusText = $("#statusText");

    function setStatus(kind, text){
      statusText.textContent = text;
      statusDot.classList.toggle("warn", kind === "warn");
    }

    function fmt(n, dec=3){
      const num = Number(n);
      if (!isFinite(num)) return "";
      return num.toFixed(dec);
    }

    function showValOrDash(v, dec=3){
      const s = fmt(v, dec);
      return s ? s : "—";
    }

    function absToText(meters){
      const s = (Number(meters)).toFixed(3);
      const [a,b] = s.split(".");
      const left = String(a ?? "0").padStart(3, "0");
      const right = String(b ?? "000").padEnd(3, "0");
      return `${ABS_PREFIX}${left}.${right}`;
    }

    function calcGeomLen(n0,e0,n1,e1){
      return Math.hypot((n1-n0),(e1-e0));
    }

    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const parsed = JSON.parse(raw);
        if (parsed?.basic) state.basic = parsed.basic;
        if (Array.isArray(parsed?.rows)) state.rows = parsed.rows;
      } catch(e){}
    }

    function save(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function getOffPozo(b){
      const v = Number(b.offPozo);
      return isFinite(v) ? v : DEFAULT_OFF_POZO;
    }
    function getOffCaja(b){
      const v = Number(b.offCaja);
      return isFinite(v) ? v : DEFAULT_OFF_CAJA;
    }

    function formatTubeCount(nFull, rem){
      if (rem > EPS) return `${nFull} + 1 colilla (${fmt(rem)} m)`;
      return `${nFull}`;
    }

    function regenerateTable(){
      const b = state.basic;

      const offPozo = getOffPozo(b);
      const offCaja = getOffCaja(b);

      const pendiente = Number(b.pendiente);
      const longTubo = Number(b.longTubo);
      const cotaPozo = Number(b.cotaPozo);
      const D = Number(b.diametro);
      const e = Number(b.espesor);

      const n0 = Number(b.nPozo), e0 = Number(b.ePozo);
      const n1 = Number(b.nCaja), e1 = Number(b.eCaja);

      const ok =
        isFinite(offPozo) && offPozo >= 0 &&
        isFinite(offCaja) && offCaja >= 0 &&
        isFinite(pendiente) &&
        isFinite(longTubo) && longTubo > 0 &&
        isFinite(cotaPozo) &&
        isFinite(D) && D > 0 &&
        isFinite(e) && e >= 0 &&
        isFinite(n0) && isFinite(e0) && isFinite(n1) && isFinite(e1);

      if (!ok){ state.rows = []; return; }

      const LgeomRaw = calcGeomLen(n0,e0,n1,e1);
      if (!(LgeomRaw > 0)){ state.rows = []; return; }

      const longEfectivaRaw = LgeomRaw - (offPozo + offCaja);
      if (!(longEfectivaRaw > 0)){ state.rows = []; return; }

      // ✅ LO QUE PIDES:
      // Inicio ABS = OffPozo
      // Final  ABS = LongEfectiva
      const absInicioRaw = offPozo;
      const absFinalRaw  = longEfectivaRaw;

      if (!(absFinalRaw > absInicioRaw + EPS)){
        state.rows = [];
        return;
      }

      // Tubos completos + posible colilla (entre absInicio y absFinal)
      const span = absFinalRaw - absInicioRaw;
      const nFull = Math.max(0, Math.floor(span / longTubo));
      let rem = span - (nFull * longTubo);
      if (Math.abs(rem) < EPS) rem = 0;
      const hasColilla = rem > EPS;

      state.basic.longEntreNodos_calc = Number(LgeomRaw.toFixed(3));
      state.basic.longEfectiva_calc  = Number(longEfectivaRaw.toFixed(3));
      state.basic.absInicio_calc      = Number(absInicioRaw.toFixed(3));
      state.basic.absFinal_calc       = Number(absFinalRaw.toFixed(3));
      state.basic.numTubes_calc = { nFull, rem: Number(rem.toFixed(3)), hasColilla };

      // Puntos: absInicio, absInicio+Lt, ..., y cierre EXACTO absFinal
      const dists = [];
      dists.push(absInicioRaw);
      for (let i = 1; i <= nFull; i++){
        const v = absInicioRaw + i * longTubo;
        if (v < absFinalRaw - EPS) dists.push(v);
      }
      dists.push(absFinalRaw);

      const uniq = Array.from(new Set(dists.map(x => Number(x.toFixed(9))))).sort((a,b)=>a-b);

      // Vector unitario Pozo->Caja (coords sobre línea)
      const uN = (n1 - n0) / LgeomRaw;
      const uE = (e1 - e0) / LgeomRaw;

      const slope = pendiente / 100;
      const outer = D + 2*e;

      const rows = [];
      for (let idx = 0; idx < uniq.length; idx++){
        const distTotal = uniq[idx]; // ✅ ABS = distancia desde nodo pozo

        const abs = absToText(distTotal);

        const cotaLomo = cotaPozo + slope * distTotal;
        const cotaExc  = cotaLomo - outer - 0.15;
        const cotaGrav = cotaExc + 0.15;

        const Norte = n0 + uN * distTotal;
        const Este  = e0 + uE * distTotal;

        let tuboInfo = "";
        if (idx < uniq.length - 1){
          const distFin = uniq[idx + 1];
          const absFin  = absToText(distFin);
          const segLen  = distFin - distTotal;

          const isColilla = (segLen + EPS < longTubo);
          const label = isColilla ? `Colilla ${fmt(segLen)} m` : `Tubo ${idx+1}`;
          tuboInfo = `${label}: ${abs} → ${absFin}`;
        }

        rows.push({
          punto: String(idx + 1),
          abs,
          dist: Number(distTotal.toFixed(3)),
          cotaLomo: Number(cotaLomo.toFixed(3)),
          cotaExc: Number(cotaExc.toFixed(3)),
          cotaGravilla: Number(cotaGrav.toFixed(3)),
          norte: Number(Norte.toFixed(3)),
          este: Number(Este.toFixed(3)),
          tuboInfo
        });
      }

      state.rows = rows;
    }

    function renderBasic(){
      const kv = $("#basicKV");
      const b = state.basic;

      const offPozo = getOffPozo(b);
      const offCaja = getOffCaja(b);

      const num = b.numTubes_calc || {};
      const nFull = Number(num.nFull ?? 0);
      const rem = Number(num.rem ?? 0);

      const items = [
        ["Longitud Nodo pozo a tubo (m)", showValOrDash(offPozo)],
        ["Longitud nodo caja a tubo (m)", showValOrDash(offCaja)],
        ["Abs inicio", (isFinite(b.absInicio_calc) ? absToText(b.absInicio_calc) : "—")],
        ["Abs final",  (isFinite(b.absFinal_calc)  ? absToText(b.absFinal_calc)  : "—")],
        ["Pendiente (%)", showValOrDash(b.pendiente)],
        ["Longitud entre nodos (m) [coord]", showValOrDash(b.longEntreNodos_calc)],
        ["Longitud efectiva (m)", showValOrDash(b.longEfectiva_calc)],
        ["Longitud tubo (m)", showValOrDash(b.longTubo)],
        ["Tubos (completos + colilla)", (isFinite(nFull) ? formatTubeCount(nFull, rem) : "—")],
        ["Cota Lomo Pozo (K0+000.000)", showValOrDash(b.cotaPozo)],
        ["Cota Lomo Caja", showValOrDash(b.cotaCaja)],
        ["Diámetro (m)", showValOrDash(b.diametro)],
        ["Espesor pared (m)", showValOrDash(b.espesor)],
        ["Nodo Pozo - Norte", showValOrDash(b.nPozo)],
        ["Nodo Pozo - Este", showValOrDash(b.ePozo)],
        ["Nodo Caja - Norte", showValOrDash(b.nCaja)],
        ["Nodo Caja - Este", showValOrDash(b.eCaja)]
      ];

      kv.innerHTML = items.map(([k,v]) => `
        <div class="k">${k}</div>
        <div class="v ${v==="—" ? "empty":""}">${v}</div>
      `).join("");

      const th = $("#tableHint");
      if (th){
        th.textContent = `Cierre garantizado: AbsFinal = LongEfectiva = ${absToText(b.absFinal_calc ?? 0)}.`;
      }
    }

    function renderRows(){
      const tbody = $("#tbody");
      tbody.innerHTML = "";

      if (!state.rows.length){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="9" style="color:rgba(17,24,39,.65); padding:16px;">
          Sin datos calculados. Abre “Editar datos básicos”, ingresa valores y guarda.
        </td>`;
        tbody.appendChild(tr);
        return;
      }

      for (const r of state.rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.punto}</td>
          <td>${r.abs}</td>
          <td class="num">${fmt(r.dist)}</td>
          <td class="num">${fmt(r.cotaLomo)}</td>
          <td class="num">${fmt(r.cotaExc)}</td>
          <td class="num">${fmt(r.cotaGravilla)}</td>
          <td class="num">${fmt(r.norte)}</td>
          <td class="num">${fmt(r.este)}</td>
          <td>${r.tuboInfo || ""}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // Dialog básicos
    const dlgBasic = $("#dlgBasic");
    const formBasic = $("#formBasic");

    function recalcDerivedInDialog(){
      const nPozo = Number(formBasic.nPozo.value);
      const ePozo = Number(formBasic.ePozo.value);
      const nCaja = Number(formBasic.nCaja.value);
      const eCaja = Number(formBasic.eCaja.value);

      const longTubo = Number(formBasic.longTubo.value);
      const offPozo = Number(formBasic.offPozo.value);
      const offCaja = Number(formBasic.offCaja.value);

      let L = "";
      let Le = "";
      let txt = "";

      if (isFinite(nPozo) && isFinite(ePozo) && isFinite(nCaja) && isFinite(eCaja)){
        const LgeomRaw = calcGeomLen(nPozo,ePozo,nCaja,eCaja);
        if (LgeomRaw > 0){
          L = fmt(LgeomRaw);

          const op = isFinite(offPozo) ? offPozo : DEFAULT_OFF_POZO;
          const oc = isFinite(offCaja) ? offCaja : DEFAULT_OFF_CAJA;

          const effRaw = LgeomRaw - (op + oc);
          if (effRaw > 0){
            Le = fmt(effRaw);

            // span real de puntos (desde OffPozo hasta LongEfectiva)
            const span = effRaw - op;
            if (isFinite(longTubo) && longTubo > 0 && span > 0){
              const nFull = Math.floor(span / longTubo);
              let rem = span - (nFull * longTubo);
              if (Math.abs(rem) < EPS) rem = 0;
              txt = formatTubeCount(nFull, rem);
            }
          }
        }
      }

      formBasic.longEntreNodos.value = L;
      formBasic.longEfectiva.value = Le;
      formBasic.numTubesPreview.value = txt;
    }

    function openBasicDialog(){
      const b = state.basic || {};
      formBasic.offPozo.value = (b.offPozo ?? DEFAULT_OFF_POZO);
      formBasic.offCaja.value = (b.offCaja ?? DEFAULT_OFF_CAJA);

      ["pendiente","cotaPozo","cotaCaja","longTubo","diametro","espesor","nPozo","ePozo","nCaja","eCaja"].forEach(k=>{
        formBasic[k].value = (b[k] ?? "");
      });

      recalcDerivedInDialog();
      dlgBasic.showModal();
    }

    ["nPozo","ePozo","nCaja","eCaja","longTubo","offPozo","offCaja"].forEach(name => {
      formBasic[name].addEventListener("input", recalcDerivedInDialog);
    });

    formBasic.addEventListener("submit", (e) => {
      e.preventDefault();
      const fd = new FormData(formBasic);
      const getN = (k) => Number(fd.get(k));

      state.basic = {
        offPozo: getN("offPozo"),
        offCaja: getN("offCaja"),
        pendiente: getN("pendiente"),
        cotaPozo: getN("cotaPozo"),
        cotaCaja: getN("cotaCaja"),
        longTubo: getN("longTubo"),
        diametro: getN("diametro"),
        espesor: getN("espesor"),
        nPozo: getN("nPozo"),
        ePozo: getN("ePozo"),
        nCaja: getN("nCaja"),
        eCaja: getN("eCaja")
      };

      regenerateTable();
      save();
      renderBasic();
      renderRows();
      dlgBasic.close();
      setStatus("ok", "Datos guardados y tabla recalculada");
    });

    // CSV
    function csvCell(v){
      const s = String(v ?? "");
      if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }

    function exportCSV(){
      if (!state.rows.length){
        setStatus("warn", "No hay tabla calculada para exportar");
        return;
      }

      const b = state.basic;
      const offPozo = getOffPozo(b);
      const offCaja = getOffCaja(b);

      const num = b.numTubes_calc || {};
      const nFull = Number(num.nFull ?? 0);
      const rem = Number(num.rem ?? 0);

      const lines = [];
      lines.push("SECCION,BASICO,VALOR");
      const basics = [
        ["Longitud Nodo pozo a tubo (m)", offPozo],
        ["Longitud nodo caja a tubo (m)", offCaja],
        ["Abs inicio", absToText(b.absInicio_calc ?? offPozo)],
        ["Abs final", absToText(b.absFinal_calc ?? 0)],
        ["Pendiente (%)", b.pendiente],
        ["Longitud entre nodos (m) [coord]", b.longEntreNodos_calc],
        ["Longitud efectiva (m)", b.longEfectiva_calc],
        ["Longitud tubo (m)", b.longTubo],
        ["Tubos (completos + colilla)", formatTubeCount(nFull, rem)],
        ["Cota Lomo Pozo (K0+000.000)", b.cotaPozo],
        ["Cota Lomo Caja", b.cotaCaja],
        ["Diámetro (m)", b.diametro],
        ["Espesor pared (m)", b.espesor],
        ["Nodo Pozo - Norte", b.nPozo],
        ["Nodo Pozo - Este", b.ePozo],
        ["Nodo Caja - Norte", b.nCaja],
        ["Nodo Caja - Este", b.eCaja]
      ];
      for (const [k,v] of basics) lines.push(`BASICOS,${csvCell(k)},${csvCell(v)}`);
      lines.push("");

      lines.push("Punto,Abs,Dist (m),Cota Lomo,Cota Excavación,Cota Gravilla,Norte,Este,Tubo");
      for (const r of state.rows){
        lines.push([r.punto,r.abs,r.dist,r.cotaLomo,r.cotaExc,r.cotaGravilla,r.norte,r.este,r.tuboInfo].map(csvCell).join(","));
      }

      const csv = lines.join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "calculo_cotas_y_coordenadas.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setStatus("ok", "CSV exportado");
    }

    function clearAll(){
      if (!confirm("¿Seguro que deseas limpiar todos los datos?")) return;
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }

    $("#btnBasic").addEventListener("click", openBasicDialog);
    $("#btnCSV").addEventListener("click", exportCSV);
    $("#btnClear").addEventListener("click", clearAll);

    // Dialog autor al abrir
    const dlgAuthor = $("#dlgAuthor");
    $("#okAuthor").addEventListener("click", () => dlgAuthor.close());
    $("#closeAuthor").addEventListener("click", () => dlgAuthor.close());

    window.addEventListener("load", () => {
      const key = "author_shown_v1";
      if (!sessionStorage.getItem(key)){
        sessionStorage.setItem(key, "1");
        dlgAuthor.showModal();
      }
    });

    // Init
    load();
    if (Object.keys(state.basic || {}).length) regenerateTable();
    renderBasic();
    renderRows();
  </script>
</body>
</html>
